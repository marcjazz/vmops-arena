Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-24.04"

  config.vm.network "private_network", ip: "192.168.56.10"

  # Copy files to writable /tmp/staging
  config.vm.provision "shell", privileged: true, inline: "mkdir -p /tmp/cloud-seed && chown vagrant:vagrant /tmp/cloud-seed && chmod 755 /tmp/cloud-seed"
  config.vm.provision "file", source: "cloud-init/user-data",   destination: "/tmp/cloud-seed/user-data"
  config.vm.provision "file", source: "cloud-init/meta-data",   destination: "/tmp/cloud-seed/meta-data"

  # Now move to real seed dir as root + set permissions + force NoCloud
  config.vm.provision "shell", privileged: true, inline: <<-SHELL
    mkdir -p /var/lib/cloud/seed/nocloud-net
    cp /tmp/cloud-seed/user-data   /var/lib/cloud/seed/nocloud-net/user-data
    cp /tmp/cloud-seed/meta-data   /var/lib/cloud/seed/nocloud-net/meta-data
    chown root:root /var/lib/cloud/seed/nocloud-net/*
    chmod 644 /var/lib/cloud/seed/nocloud-net/*
    chmod 700 /var/lib/cloud/seed/nocloud-net

    # Force NoCloud datasource
    cat > /etc/cloud/cloud.cfg.d/99_nocloud.cfg <<'EOF'
datasource_list: [ NoCloud, None ]
EOF

    # Clean previous state and reboot to force re-detection
    cloud-init clean --logs --reboot || true
  SHELL

  # Wait for cloud-init after reboot
  config.vm.provision "shell", inline: "cloud-init status --wait || true"

  config.vm.provider "vmware_desktop" do |v|
    v.vmx["numvcpus"] = "2"
    v.vmx["memsize"] = "2048"
  end

  config.vm.provider "virtualbox" do |vb|
    vb.memory = "2048"
    vb.cpus = 2
  end
end
