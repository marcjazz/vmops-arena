---
name: CI Validation

on:
  pull_request:

jobs:
  linting:
    name: Linting and Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y yamllint

      - name: Validate YAML syntax
        run: |
          SUBMISSION_DIR="submissions/${{ github.actor }}"
          if [ -f "$SUBMISSION_DIR/cloud-init/user-data.yaml" ]; then
            yamllint "$SUBMISSION_DIR/cloud-init/user-data.yaml"
          else
            echo "Warning: cloud-init/user-data.yaml not found, skipping yamllint"
          fi

      - name: Install Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | \
            sudo gpg --dearmor -o \
            /usr/share/keyrings/hashicorp-archive-keyring.gpg
          REPO="https://apt.releases.hashicorp.com"
          KEY="/usr/share/keyrings/hashicorp-archive-keyring.gpg"
          echo "deb [signed-by=$KEY] $REPO $(lsb_release -cs) main" | \
            sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install -y vagrant

      - name: Validate Vagrantfile syntax
        run: |
          SUBMISSION_DIR="submissions/${{ github.actor }}"
          if [ -f "$SUBMISSION_DIR/Vagrantfile" ]; then
            cd "$SUBMISSION_DIR"
            vagrant validate --ignore-provider
          else
            echo "Error: Vagrantfile not found"
            exit 1
          fi

  validate_report:
    name: Report Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check required files existence
        run: |
          SUBMISSION_DIR="submissions/${{ github.actor }}"
          for file in Vagrantfile cloud-init/user-data.yaml \
            validation_report.txt; do
            if [ ! -f "$SUBMISSION_DIR/$file" ]; then
              echo "Error: $SUBMISSION_DIR/$file is missing"
              exit 1
            fi
          done

      - name: Verify validation report status
        run: |
          SUBMISSION_DIR="submissions/${{ github.actor }}"
          TOTAL_TESTS=$(grep -c "\[PASS\]" validate_lab.sh)
          THRESHOLD=$(( (TOTAL_TESTS * 70 + 99) / 100 ))
          PASS_COUNT=$(grep -c "\[PASS\]" \
            "$SUBMISSION_DIR/validation_report.txt")

          echo "Total expected tests: $TOTAL_TESTS"
          echo "Required threshold (70%): $THRESHOLD"
          echo "Found $PASS_COUNT [PASS] entries in submission."

          if [ "$PASS_COUNT" -lt "$THRESHOLD" ]; then
            echo "Error: Found $PASS_COUNT [PASS] entries, but at least \
          $THRESHOLD are required."
            exit 1
          fi
