#cloud-config
# vim: syntax=yaml

# This user-data file is designed for cloud-init to provision a hardened Ubuntu VM.

# 1. SET HOSTNAME
# Sets the hostname of the machine. Helpful for identification.
hostname: "hardened-vm"
manage_etc_hosts: true

# 2. USER & ENVIRONMENT
# Creates the required 'student' user and configures their environment.
users:
  - name: student
    sudo: ['ALL=(ALL) NOPASSWD:ALL'] # Grant sudo privileges without a password
    groups: sudo # Ensure user is in the sudo group
    shell: /bin/zsh # Set the default shell to Zsh
    ssh_authorized_keys:
      - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJ0Mcea2+03jZVyXd/byiEy4aRs+1atHhTkmcSXmRubo nkwajudetambe@gmail.com"

# 3. PACKAGE MANAGEMENT
# Installs all necessary packages.
package_update: true
package_upgrade: true
packages:
  - git
  - curl
  - zsh
  - nginx
  - ufw

# 4. SECURITY HARDENING & ENVIRONMENT SETUP
# Executes commands to configure the system.
runcmd:
  # Install Oh My Zsh for the student user 
  - su - student -c 'sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended'
  
  # Configure UFW firewall
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw --force enable
  
  # Harden SSH configuration
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
  - systemctl restart ssh
  
  # Start and enable nginx
  - systemctl start nginx
  - systemctl enable nginx


