#cloud-config

# 1. Create the student user with specific SSH key
users:
  - name: student
    groups: sudo
    shell: /bin/zsh
    sudo: 'ALL=(ALL) NOPASSWD:ALL'
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPKSmSjLf8z6qFpQ4i5G9gyFPJhMjLsAG9UO/vZhdw4z test-lab

# 2. Package Installation
packages:
  - git
  - curl
  - zsh
  - nginx
  - ufw

# 3. Automation Logic (Firewall, Oh My Zsh, and SSH Hardening)
runcmd:
  # Install Oh My Zsh for student (unattended mode)
  - [ sh, -c, 'su - student -c "curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | sh -s -- --unattended"' ]
  
  # Configure UFW (Uncomplicated Firewall)
  - ufw default deny incoming
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw --force enable

  # SSH Hardening: Disable password auth and root login
  - sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication no/' /etc/ssh/sshd_config
  - sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config
  - systemctl restart ssh